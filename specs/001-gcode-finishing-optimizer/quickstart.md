# Quickstart Guide: GCode Finishing Pass Optimizer

**Feature**: 001-gcode-finishing-optimizer
**Target Audience**: CNC operators using Snapmaker Luban
**Estimated Time**: 5 minutes

This guide will help you get up and running with the GCode Finishing Pass Optimizer to reduce machining time on finishing passes.

---

## What This Tool Does

The GCode Finishing Pass Optimizer removes redundant cutting operations from finishing pass GCode files. When you've completed a rough cut with a material allowance (e.g., 1mm remaining), the finishing pass GCode often includes toolpaths for depths already handled by the rough cut. This tool filters out those redundant operations, reducing machining time by 20-40% while maintaining identical final surface quality.

---

## Quick Example

**Before optimization**: 100,000 lines, 60 minutes machining time
**After optimization**: 72,000 lines, 48 minutes machining time
**Result**: Saved 12 minutes of machine time

---

## Installation

### Download Pre-Built Binary

Visit the [Releases page](https://github.com/chrisns/snapmaker-cnc-finisher/releases) and download the binary for your platform:

- **macOS Intel**: `snapmaker-cnc-finisher-darwin-amd64`
- **macOS ARM (M1/M2/M3)**: `snapmaker-cnc-finisher-darwin-arm64`
- **Windows**: `snapmaker-cnc-finisher-windows-amd64.exe`
- **Linux**: `snapmaker-cnc-finisher-linux-amd64`

### Make Executable (macOS/Linux)

```bash
chmod +x snapmaker-cnc-finisher-*
```

### Add to PATH (Optional)

**macOS/Linux**:
```bash
sudo mv snapmaker-cnc-finisher-* /usr/local/bin/snapmaker-cnc-finisher
```

**Windows**:
1. Move `snapmaker-cnc-finisher-windows-amd64.exe` to `C:\Program Files\SnapmakerTools\`
2. Rename to `snapmaker-cnc-finisher.exe`
3. Add `C:\Program Files\SnapmakerTools\` to your PATH

### Build from Source (Advanced)

**Requirements**: Go 1.25.3 or later

```bash
git clone https://github.com/chrisns/snapmaker-cnc-finisher.git
cd snapmaker-cnc-finisher
go build -o snapmaker-cnc-finisher cmd/snapmaker-cnc-finisher/main.go
```

---

## Basic Usage

### Step 1: Prepare Your Files

You need:
1. **Finishing pass GCode file** (generated by Snapmaker Luban)
2. **Rough cut allowance value** (the material depth left after your rough cut, e.g., 1.0mm)

### Step 2: Run the Optimizer

**Syntax**:
```bash
snapmaker-cnc-finisher <input-file> <allowance> <output-file>
```

**Example**:
```bash
snapmaker-cnc-finisher finishing.cnc 1.0 finishing_optimized.cnc
```

### Step 3: Review the Output

The tool will display a summary like:
```
✓ Optimization complete!

Input:  finishing.cnc (1.2 MB, 100,000 lines)
Output: finishing_optimized.cnc (850 KB, 72,450 lines)

Results:
  Lines removed:       27,550 (27.6%)
  File size reduced:   350 KB (29.2%)
  Estimated time saved: 12.5 minutes

Z-axis reference: Detected from header metadata (min_z/max_z)
Strategy used: safe

Processing time: 6.4 seconds
```

### Step 4: Use the Optimized File

Load `finishing_optimized.cnc` into your Snapmaker machine just like any other GCode file. The final result will be identical to running the original finishing pass.

---

## Common Scenarios

### Scenario 1: Standard Workflow (1mm Allowance)

```bash
snapmaker-cnc-finisher finishing_pass.cnc 1.0 finishing_pass_opt.cnc
```

**When to use**: Most common rough+finish workflows

### Scenario 2: Fine Finishing (0.5mm Allowance)

```bash
snapmaker-cnc-finisher fine_finish.cnc 0.5 fine_finish_opt.cnc
```

**When to use**: Higher precision requirements with smaller allowance

### Scenario 3: Heavy Finishing (2mm Allowance)

```bash
snapmaker-cnc-finisher heavy_finish.cnc 2.0 heavy_finish_opt.cnc
```

**When to use**: Faster rough cuts with more material left for finishing

### Scenario 4: Batch Processing (Force Overwrite)

```bash
snapmaker-cnc-finisher input1.cnc 1.0 output1.cnc --force
snapmaker-cnc-finisher input2.cnc 1.5 output2.cnc --force
```

**When to use**: Automating optimization for multiple files without prompts

---

## Advanced Options

### Multi-Axis Move Strategies

For 4-axis CNC machines or complex toolpaths, you can control how multi-axis moves are handled:

```bash
snapmaker-cnc-finisher input.cnc 1.0 output.cnc --strategy=<value>
```

**Available Strategies**:

| Strategy | Behavior | When to Use |
|----------|----------|-------------|
| `safe` (default) | Preserve entire move if Z exceeds allowance | Conservative, guarantees no missed finishing work |
| `all-axes` | Preserve only if all axes indicate finishing | Balanced approach for multi-axis jobs |
| `split` | Attempt to split multi-axis moves | Maximize savings on complex toolpaths |
| `aggressive` | Remove move if Z is shallow | Maximum optimization, higher risk |

**Example**:
```bash
snapmaker-cnc-finisher 4axis_finish.cnc 1.0 output.cnc --strategy=all-axes
```

### Force Overwrite

Skip confirmation prompt when output file exists:

```bash
snapmaker-cnc-finisher input.cnc 1.0 output.cnc --force
```

**Use case**: Scripting, CI/CD pipelines, repeated optimizations

---

## Verifying Results

### Visual Inspection

**Before running on your machine**, inspect the optimized file:

1. Open `finishing_optimized.cnc` in a text editor
2. Verify header is preserved
3. Spot-check that G1 commands with deep Z values are still present
4. Confirm shallow cuts (Z > -allowance) are removed

### Test Cut Recommended

For critical parts, run a test cut on scrap material first to verify surface quality matches expectations.

---

## Troubleshooting

### Error: "Input file not found"

**Solution**: Verify the file path is correct. Use absolute paths if needed:
```bash
snapmaker-cnc-finisher /full/path/to/finishing.cnc 1.0 output.cnc
```

### Error: "Invalid allowance value"

**Solution**: Ensure allowance is a positive number (use `.` for decimals, not `,`):
```bash
# Correct
snapmaker-cnc-finisher input.cnc 1.5 output.cnc

# Incorrect
snapmaker-cnc-finisher input.cnc 1,5 output.cnc  # Wrong decimal separator
snapmaker-cnc-finisher input.cnc -1.0 output.cnc  # Negative value
```

### Warning: "Snapmaker header missing or malformed"

**Meaning**: Tool couldn't find Snapmaker Luban header but will proceed with fallback Z-reference.

**Impact**: Tool may be less accurate in determining Z-axis reference point.

**Solution**: If results are incorrect, ensure your GCode was generated by Snapmaker Luban. For non-Luban files, results may vary.

### No Lines Removed (0% reduction)

**Possible Causes**:
1. Allowance value too small (try increasing it)
2. Finishing pass already starts at depths beyond allowance
3. File contains only rapid moves (G0) and machine codes (M-codes)

**Solution**: Review your rough cut settings and ensure finishing pass includes shallow toolpaths.

### Too Many Lines Removed (>80% reduction)

**Possible Causes**:
1. Allowance value too large
2. Incorrect Z-axis reference interpretation

**Solution**: Verify allowance matches your rough cut settings. Check warnings for Z-axis reference method used.

---

## Performance Expectations

| File Size | Line Count | Processing Time | Typical Reduction |
|-----------|------------|-----------------|-------------------|
| Small | 10,000 | < 1 second | 15-30% |
| Medium | 100,000 | 3-8 seconds | 20-40% |
| Large | 1,000,000 | 30-60 seconds | 20-40% |
| Very Large | 10,000,000 | 5-10 minutes | 20-40% |

**Note**: Processing times assume modern hardware (4+ cores, 8GB+ RAM, SSD).

---

## Best Practices

### 1. Always Keep Original Files

Never overwrite your original finishing pass GCode:
```bash
# Good
snapmaker-cnc-finisher finishing.cnc 1.0 finishing_optimized.cnc

# Bad (overwrites original)
snapmaker-cnc-finisher finishing.cnc 1.0 finishing.cnc --force
```

### 2. Match Allowance to Rough Cut

Use the exact allowance value from your rough cut settings. Common values:
- **0.5mm**: Fine finishing, high precision
- **1.0mm**: Standard finishing (most common)
- **1.5-2.0mm**: Heavy finishing, faster rough cuts

### 3. Verify Output Before Machining

For critical parts, always review the optimized output:
- Check file size reduction is reasonable (15-40%)
- Inspect summary statistics
- Consider a test cut on scrap material

### 4. Use Consistent Workflows

For repetitive jobs, document your settings:
```bash
# My standard brass engraving workflow
snapmaker-cnc-finisher finishing.cnc 1.0 output.cnc --strategy=safe
```

---

## Integration with Workflows

### Snapmaker Luban Workflow

```
1. Design in CAD/CAM software
2. Generate rough cut (1mm allowance) → rough.cnc
3. Generate finishing pass → finishing.cnc
4. Optimize: snapmaker-cnc-finisher finishing.cnc 1.0 finishing_opt.cnc
5. Load rough.cnc into Snapmaker → run rough cut
6. Load finishing_opt.cnc into Snapmaker → run finishing pass
```

### Scripted Automation

**Example Bash Script** (`optimize_all.sh`):
```bash
#!/bin/bash

for file in *_finishing.cnc; do
    base=$(basename "$file" _finishing.cnc)
    snapmaker-cnc-finisher "$file" 1.0 "${base}_optimized.cnc" --force
    echo "Optimized: $file → ${base}_optimized.cnc"
done
```

**Usage**:
```bash
chmod +x optimize_all.sh
./optimize_all.sh
```

---

## Getting Help

### Display Help Message

```bash
snapmaker-cnc-finisher --help
```

### Check Version

```bash
snapmaker-cnc-finisher --version
```

### Report Issues

If you encounter bugs or unexpected behavior:

1. Check the [GitHub Issues](https://github.com/chrisns/snapmaker-cnc-finisher/issues) page
2. Provide:
   - Tool version (`--version`)
   - Platform (macOS/Windows/Linux)
   - Error message (full text)
   - Sample GCode file (if possible)

---

## FAQ

### Q: Does this work with non-Snapmaker GCode?

**A**: The tool is optimized for Snapmaker Luban format but will attempt to parse generic GCode. Results may vary. If the Snapmaker header is missing, a warning will be displayed but processing will continue.

### Q: Will the optimized file produce identical results?

**A**: Yes. The tool only removes cutting operations at depths already handled by the rough cut. All finishing work is preserved, ensuring identical final surface quality.

### Q: Can I use this for 3D printing GCode?

**A**: No. This tool is designed for CNC machining GCode. 3D printing GCode uses different logic (layer-based) and should not be processed with this tool.

### Q: How do I know if my allowance is correct?

**A**: Use the same allowance value you specified in your rough cut CAM settings. This is typically 0.5-2.0mm for most CNC workflows.

### Q: Can I process multiple files at once?

**A**: The tool processes one file at a time. For batch processing, use shell scripting (see "Integration with Workflows" section above).

### Q: Is there a GUI version?

**A**: No. The tool is command-line only per the design specification. GUI support is out of scope.

---

## Next Steps

- **Read the full documentation**: [GitHub Repository](https://github.com/chrisns/snapmaker-cnc-finisher)
- **Explore advanced strategies**: Try different `--strategy` values for complex toolpaths
- **Automate your workflow**: Integrate into your CNC workflow scripts
- **Contribute**: Report issues or submit improvements on GitHub

---

**Generated By**: Claude Code (Sonnet 4.5)
**Last Updated**: 2025-10-26
**References**: [cli-interface.md](./contracts/cli-interface.md), [spec.md](./spec.md)
